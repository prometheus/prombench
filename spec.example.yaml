# Environment Variables from Prow
# CLUSTER_NAME
# PROMETHEUS_1_NAME
# PROMETHEUS_1_IMAGE
# PROMETHEUS_2_NAME
# PROMETHEUS_2_IMAGE

prometheus:
  # n1-standard-4 has 15Gi memory and 4 vCPUs
  machineType: n1-standard-1
  disksizegb: 100
  localssdcount: 1
  scrapeInterval: 4s
  instances:
  - name: PROMETHEUS_1_NAME
    image: PROMETHEUS_1_IMAGE
    flags:
    - '--storage.tsdb.min-block-duration=15m'
    - '--storage.tsdb.max-block-duration=4h'
  - name: PROMETHEUS_2_NAME
    image: PROMETHEUS_2_IMAGE
    flags:
    - '--storage.tsdb.min-block-duration=15m'
    - '--storage.tsdb.max-block-duration=4h'

workers:
  nodecount: 1
  # n1-standard-1 has 3.75Gi memory and 1 vCPU
  machineType: n1-standard-2
  disksizegb: 100
  localssdcount: 0
  appInstances: 5
loadGenerator:
  scaler:
    name: fake-webserver
    high: 5
    low: 2
    intervalMinutes: 5
  querier:
    targets:
    - name: PROMETHEUS_1_NAME
    - name: PROMETHEUS_2_NAME
    groups:
    - name: simple_range
      interval: 4s
      type: range
      start: 2h
      end: 1h
      step: 15s
      queries:
      - expr: go_goroutines
      - expr: container_memory_rss
      - expr: kube_pod_container_info
      - expr: codelab_api_http_requests_in_progress
      - expr: codelab_api_requests_total
    - name: aggr_instant
      interval: 10s
      type: instant
      queries:
      - expr: sum by(image) (container_memory_rss)
      - expr: sum by(instance) (rate(node_cpu{mode!="idle"}[2m]))
      - expr: sum by(instance) (rate(node_cpu[2m]))
      - expr: sum by(instance) (rate(codelab_api_requests_total[2m]))
      - expr: sum by(instance) (rate(codelab_api_requests_total{method=~"GET|POST"}[2m]))
    - name: aggr_range
      interval: 10s
      type: range
      start: 1h
      end: 0h
      step: 15s
      queries:
      - expr: sum by(image) (container_memory_rss)
      - expr: sum by(instance) (rate(node_cpu{mode!="idle"}[2m]))
      - expr: sum by(instance) (rate(node_cpu[2m]))
      - expr: sum by(instance) (rate(codelab_api_requests_total[2m]))
      - expr: sum by(instance) (rate(codelab_api_requests_total{method=~"GET|POST"}[2m]))
    - name: heavy_instant
      interval: 20s
      queries:
      - expr: rate(codelab_api_requests_total{method=~"GET|POST"}[1m])
      - expr: sum without(instance) (rate(codelab_api_requests_total{method=~"GET|POST"}[1m]))
      - expr: histogram_quantile(0.99, sum by(path, le) (rate(codelab_api_request_duration_seconds_bucket{method="POST"}[1m])))
      - expr: histogram_quantile(0.99, sum by(path, method, le) (rate(codelab_api_request_duration_seconds_bucket{method="POST"}[1m])))
      - expr: histogram_quantile(0.99, sum by(instance, le) (rate(codelab_api_request_duration_seconds_bucket{method="POST"}[1m])))